<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Portal | Gainers Future</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background-color: #f3f4f6; }
        .view-section { display: none; animation: fadeUp 0.3s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn.active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .row-New { border-left: 4px solid #94a3b8; }
        .row-Interested { background-color: #ecfdf5; border-left: 4px solid #10b981; }
        .row-Busy { background-color: #fff7ed; border-left: 4px solid #f59e0b; }
        .row-No_Response { background-color: #fef2f2; border-left: 4px solid #ef4444; }
        .row-Enrolled { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 flex justify-between h-16 items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">{{ employee.full_name|slice:":1" }}</div>
                <div>
                    <h2 class="text-sm font-bold text-gray-800">{{ employee.full_name }}</h2>
                    <p class="text-xs text-gray-500">Target: 7 | Achieved: {{ sales_count }}</p>
                </div>
            </div>
            <a href="{% url 'logout' %}" class="text-xs text-red-500 font-bold border border-red-200 px-3 py-1.5 rounded-full hover:bg-red-50">Logout</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 mt-6">
        
        <!-- Tab Navigation -->
        <div class="flex gap-4 mb-6 border-b border-gray-200 pb-2">
            <button onclick="switchTab('dashboard')" class="tab-btn active text-indigo-600 font-bold text-sm px-4 py-2 border-b-2 border-indigo-600">Dashboard</button>
            <button onclick="switchTab('crm')" class="tab-btn text-gray-500 font-medium text-sm px-4 py-2 hover:text-indigo-600">My Leads (CRM)</button>
            <button onclick="switchTab('cms')" class="tab-btn text-gray-500 font-medium text-sm px-4 py-2 hover:text-indigo-600">My Batches (CMS)</button>
        </div>

        <!-- 1. DASHBOARD TAB -->
        <div id="view-dashboard" class="view-section active">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- ATTENDANCE -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 text-center">
                    <h3 class="font-bold text-slate-700 uppercase text-xs tracking-wider mb-4">Daily Attendance</h3>
                    <form action="{% url 'mark_own_attendance' %}" method="POST">
                        {% csrf_token %}
                        {% if status == 'Pending' %}
                            <input type="hidden" name="action_type" value="check_in">
                            <button class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">CHECK IN NOW</button>
                        {% elif status == 'Active' %}
                            <p class="text-green-600 font-bold mb-2">● Active ({{ in_time|time:"h:i A" }})</p>
                            <input type="hidden" name="action_type" value="check_out">
                            {% if can_checkout %}
                                <button class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">CHECK OUT</button>
                            {% else %}
                                <button disabled class="w-full py-3 bg-yellow-100 text-yellow-700 rounded-xl font-bold cursor-not-allowed">Wait 1 Hour</button>
                            {% endif %}
                        {% else %}
                            <p class="text-gray-500 font-bold py-3 bg-gray-100 rounded-xl">Shift Completed ✅</p>
                        {% endif %}
                    </form>
                </div>
                <!-- STATS -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-slate-700 uppercase text-xs tracking-wider mb-4">Pipeline</h3>
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="p-3 bg-blue-50 rounded-lg"><p class="text-xl font-bold text-blue-600">{{ all_leads.count }}</p><p class="text-xs text-gray-500">Leads</p></div>
                        <div class="p-3 bg-indigo-50 rounded-lg"><p class="text-xl font-bold text-indigo-600">{{ my_batches.count }}</p><p class="text-xs text-gray-500">Batches</p></div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Logs -->
            <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b bg-gray-50 font-bold text-sm text-gray-700">Attendance History</div>
                <table class="w-full text-sm text-left">
                    <thead class="bg-white uppercase text-xs"><tr><th class="p-3">Date</th><th class="p-3">In</th><th class="p-3">Out</th></tr></thead>
                    <tbody>
                        {% for log in history %}
                        <tr class="border-b last:border-0 hover:bg-gray-50">
                            <td class="p-3">{{ log.date|date:"d M" }}</td>
                            <td class="p-3">{{ log.in_time|default:"-" }}</td>
                            <td class="p-3">{{ log.out_time|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. CRM TAB -->
        <div id="view-crm" class="view-section">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-100 uppercase text-xs">
                            <tr><th class="p-4">Name</th><th class="p-4">Contact</th><th class="p-4">Update Status</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for lead in all_leads %}
                            <tr class="hover:bg-gray-50 transition row-{{ lead.status }}">
                                <td class="p-4 font-bold">{{ lead.name }}</td>
                                <td class="p-4 flex gap-2">
                                    <a href="https://wa.me/{{ lead.phone }}" target="_blank" class="text-green-500 text-lg"><i class="fab fa-whatsapp"></i></a>
                                    <a href="tel:{{ lead.phone }}" class="text-blue-500 text-lg"><i class="fas fa-phone"></i></a>
                                </td>
                                <td class="p-4">
                                    <form action="{% url 'update_lead_status' %}" method="POST">
                                        {% csrf_token %}
                                        <input type="hidden" name="lead_id" value="{{ lead.id }}">
                                        <select name="status" class="p-1 border rounded text-xs" onchange="this.form.submit()">
                                            <option value="{{ lead.status }}" selected>{{ lead.status }}</option>
                                            <option value="Busy">Busy</option>
                                            <option value="Interested">Interested</option>
                                            <option value="Enrolled">Enrolled</option>
                                        </select>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}<tr><td colspan="3" class="p-8 text-center text-gray-400">No leads.</td></tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. CMS TAB (MY BATCHES) - NEW -->
        <div id="view-cms" class="view-section">
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- My Batches -->
                <div class="space-y-4">
                    <h4 class="font-bold text-slate-700">My Batches (Coordinator)</h4>
                    {% for batch in my_batches %}
                    <a href="{% url 'batch_details' batch.id %}" class="block bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-500 transition group">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-slate-800 group-hover:text-indigo-600">{{ batch.name }}</h3>
                            <span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">{{ batch.students.count }} Students</span>
                        </div>
                        <p class="text-xs text-gray-500">Manage Tasks & Progress</p>
                        <div class="mt-4 pt-3 border-t text-xs font-bold text-indigo-600 flex items-center gap-2">
                            View Details <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>
                    {% empty %}
                    <div class="bg-white p-8 rounded-xl border border-dashed border-gray-300 text-center">
                        <p class="text-gray-400">No batches assigned to you yet.</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Support Tickets (From My Batch Students) -->
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden h-96">
                    <div class="p-4 bg-slate-50 border-b font-bold text-slate-700">Student Issues</div>
                    <div class="overflow-y-auto h-full pb-10">
                        {% for ticket in my_tickets %}
                        <div class="p-4 border-b hover:bg-slate-50">
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-sm text-rose-600">{{ ticket.client.name }}</span>
                                <span class="text-[10px] text-gray-400">{{ ticket.created_at|date:"M d" }}</span>
                            </div>
                            <p class="text-xs font-bold text-slate-800">{{ ticket.subject }}</p>
                            <p class="text-xs text-slate-600 mt-1">"{{ ticket.description }}"</p>
                            <a href="{% url 'resolve_issue' ticket.id %}" class="mt-2 inline-block text-[10px] bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">Mark Resolved</a>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-400 py-6 text-sm">No pending issues.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        function switchTab(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active', 'text-indigo-600', 'border-b-2', 'border-indigo-600');
                el.classList.add('text-gray-500');
            });
            document.getElementById('view-' + viewId).classList.add('active');
            event.target.classList.add('active', 'text-indigo-600', 'border-b-2', 'border-indigo-600');
            event.target.classList.remove('text-gray-500');
        }
    </script>
</body>
</html>